import os
import sys
import subprocess

# Ã–n tanÄ±mlÄ± kolay zamanlama kalÄ±plarÄ±
PRESETS = {
    "dakikalÄ±k": "* * * * *",
    "saatlik": "0 * * * *",
    "gÃ¼nlÃ¼k": "0 0 * * *",
    "haftalÄ±k": "0 0 * * 0",
    "aylÄ±k": "0 0 1 * *",
    "geceyarÄ±sÄ±": "0 0 * * *"
}

def get_crontab():
    """Mevcut crontab iÃ§eriÄŸini Ã§eker."""
    try:
        return subprocess.check_output("crontab -l", shell=True, stderr=subprocess.DEVNULL).decode().splitlines()
    except:
        return []

def save_crontab(lines):
    """Yeni crontab iÃ§eriÄŸini sisteme yÃ¼kler."""
    temp_file = "temp_cron.txt"
    with open(temp_file, "w") as f:
        for line in lines:
            f.write(line + "\n")
    os.system(f"crontab {temp_file}")
    os.remove(temp_file)

def add_task(schedule, script_path):
    """Yeni bir yedekleme gÃ¶revi ekler."""
    cron_time = PRESETS.get(schedule, schedule)
    full_path = os.path.abspath(script_path)
    
    if not os.path.exists(full_path):
        print(f"âŒ Hata: '{full_path}' dosya yolu bulunamadÄ±!")
        return

    new_line = f"{cron_time} {full_path} #EBS_TASK"
    cron_lines = get_crontab()
    cron_lines.append(new_line)
    save_crontab(cron_lines)
    print(f"âœ… BaÅŸarÄ±lÄ±: GÃ¶rev eklendi. ({schedule})")

def list_tasks():
    """TÃ¼m EBS gÃ¶revlerini listeler."""
    lines = get_crontab()
    ebs_tasks = [l for l in lines if "#EBS_TASK" in l]
    
    if not ebs_tasks:
        print("â„¹ï¸ HenÃ¼z tanÄ±mlÄ± bir EBS gÃ¶revi bulunmuyor.")
        return

    print("\n--- MEVCUT YEDEKLEME GÃ–REVLERÄ°NÄ°Z ---")
    print(f"{'ID':<4} {'ZAMANLAMA':<15} {'KOMUT / SCRIPT'}")
    for i, task in enumerate(ebs_tasks):
        parts = task.split()
        time_part = " ".join(parts[:5])
        cmd_part = parts[5]
        print(f"{i:<4} {time_part:<15} {cmd_part}")
    print("--------------------------------------\n")

def delete_task(task_id):
    """ID numarasÄ±na gÃ¶re gÃ¶revi siler."""
    lines = get_crontab()
    ebs_tasks = [l for l in lines if "#EBS_TASK" in l]
    
    try:
        task_to_delete = ebs_tasks[int(task_id)]
        new_lines = [l for l in lines if l != task_to_delete]
        save_crontab(new_lines)
        print(f"ğŸ—‘ï¸ GÃ¶rev baÅŸarÄ±yla silindi.")
    except (IndexError, ValueError):
        print("âŒ Hata: GeÃ§ersiz ID numarasÄ±!")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("\n--- EBS (EasyBackup Scheduler) ---")
        print("KullanÄ±m KomutlarÄ±:")
        print("  add [zaman] [dosya]  : GÃ¶rev ekler (Ã–rn: add gÃ¼nlÃ¼k yedek.sh)")
        print("  list                 : TÃ¼m gÃ¶revleri listeler")
        print("  delete [id]          : GÃ¶revi siler")
        print("\nZaman KalÄ±plarÄ±: dakikalÄ±k, saatlik, gÃ¼nlÃ¼k, haftalÄ±k, aylÄ±k")
    else:
        cmd = sys.argv[1]
        if cmd == "add" and len(sys.argv) == 4:
            add_task(sys.argv[2], sys.argv[3])
        elif cmd == "list":
            list_tasks()
        elif cmd == "delete" and len(sys.argv) == 3:
            delete_task(sys.argv[2])
        else:
            print("âŒ YanlÄ±ÅŸ komut kullanÄ±mÄ±!")
